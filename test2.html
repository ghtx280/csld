<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * {
    margin: 0;
  }
  html, body {
    height: 100%;
  }
  body {
    margin: 0;
    padding: 0;
    font-family: sans-serif;
  }

  .fff {
    position: relative;
    width:  100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    user-select: none;
    overflow: hidden;
  }


  .fff div {
    position: absolute;
    width: 300px; 
    height: 420px;
    background-color: #8f9eeb;
    border-radius: 10px;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.3);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .fff div p {
    font-size: 50px;
    color: white;
    user-select: text;
  }

  .trans div {
    transition: all var(--time, 100ms);
  }

  .active p {
    color: red
  }
</style>
</head>
<body>
  <button onclick="add()">add</button>
  <button onclick="del()">del</button>
  <button onclick="save()">save</button>
  <span> - </span>
  <button onclick="setCenter(-6, is_anim)">next</button>
  <button onclick="setCenter(6 , is_anim)">prev</button>
  <input type="checkbox" onchange="is_anim = !is_anim">

  <div class="fff" id="slider">
    <div><p>1</p></div>
    <div><p>2</p></div>
    <div><p>3</p></div>
    <div><p>4</p></div>
    <div><p>5</p></div>
  </div>

  <script>

  let is_anim = true

  function nav(dir) {
    
  }
 
  
  let len = 0;

  if (localStorage.len) {
    len = +localStorage.len
  }

  let max_index = 0;
  let step = 30;
  let mouse = false;
  let can_move = true;
  let transition_time = 200;
  let previousTouch;
  let slides = slider.children;
  let count = 0;
  let last_len = 0
  let last_force = 0
  let pair = getPair();

  console.log(len);


  function add() {
    slider.innerHTML += `<div><p>${count + 1}</p></div>`

    max_index = count * step;

    let last = slider.children
    last = last[last.length - 1]
    last.dataset.index = max_index;
    last.dataset.angle = count % 2 ? -2 : 2
    last.style.transform = `translate3d(0,1000px,0)`;
    last.style.filter = "opacity(0)";

    count++;
    setCenter(null)
  }

  function del() {
    max_index -= step;

    let last = slider.children
    last = last[last.length - 1]
    last.remove()

    count--;

    setCenter(null)
  }

  function save() {
    localStorage.len = len
  }

  /*************************************/

  slider.style = `--time: ${transition_time}ms`;

  for (const slide of slides) {
    max_index = count * step;

    slide.dataset.index = max_index;
    slide.dataset.angle = count % 2 ? -3 : 3
    slide.style.transform = `translate3d(0,1000px,0)`;
    slide.style.filter = "opacity(0)";

    count++;
  }

  /*************************************/

  function throttle(func, timeout = 50) {
    let last = 0;

    return function(...args) {
      const now = Date.now();
      if (now - last > timeout) func(...args) 
      last = now;
    }
  }

  function getPair(elem) {
    let active = elem || document.querySelector(`[data-index="${len}"]`);
    let next   = active?.nextElementSibling;
    let prev1  = active?.previousElementSibling;
    let prev2  = prev1?.previousElementSibling;
    let prev3  = prev2?.previousElementSibling;

    return [prev3, prev2, prev1, active, next];
  }

  function setCenter(force, flat) {
    console.log(force, flat);
    mouse = false;
    let offset = len % step;

    if (offset > step / 2) {
      len = len + (step - offset);
    } else {
      len = len - offset;
    }

    if (Math.abs(force) > 5) {
      len = force < 0 ? len + step : len - step
    }

    len = len <= max_index ? len : max_index;
    len = len >= 0 ? len : 0;

    if (len > last_len + step) {
      len = last_len + step;
    }

    if (len < last_len - step) {
      len = last_len - step;
    }

    len = Math.round(len)
    last_len = len

    document.querySelector(".active")?.classList.remove("active");
    let active = document.querySelector(`[data-index="${len}"]`);
    active.classList.add("active");
    pair = getPair(active);
    
    if (force == null || !flat) {
      move({ movementY: -1 }, true);
      return
    }
    
    slider.classList.add("trans");
    move({ movementY: -1 }, true);
    can_move = false;
    setTimeout(
      () => {
        slider.classList.remove("trans");
        can_move = true;
      },
      transition_time
    );
  }

  function move(e, once) {
    if (mouse || once) {
      let divisor = 40

      last_force = e.movementY
      
      len -= e.movementY / (innerHeight / (len < 0 || len > max_index ? divisor / 8 : divisor));

      for (const slide of pair) {
        if (!slide) continue;
        let loc_pos = +(len - slide.dataset.index).toFixed(1);
        let angle = +slide.dataset.angle;
        let pos;
        let scl;
        let rot;
        let opc;

        // if (slide.classList.contains("active")) {
        //   console.log((1 - loc_pos / step ) * 1.33);
        // }

        if (loc_pos > 0) {
          pos = -loc_pos;
          scl = -loc_pos * 2
          rot = (loc_pos * angle) / 40
          opc = 1 - loc_pos / step / 3
        } else {
          pos = -loc_pos * 20;
          scl = 1;
          rot = 0;
          opc = 1 - -loc_pos / 30;
        }

        slide.style.transform = `perspective(500px)
        translate3d(0, ${pos * 1.2}px, ${scl}px)
        rotateZ(${rot}deg)`;

        slide.style.filter = `opacity(${opc})`;
      }
    }
  }

  /*************************************/

  slider.addEventListener("touchstart", () => {
    if (can_move) mouse = true;
  });

  slider.addEventListener("touchend", () => {
    previousTouch = null;
    setCenter(last_force);
  });

  /*************************************/

  slider.addEventListener("touchmove", (e) => {
    e.preventDefault();
    const touch = e.touches[0];

    if (previousTouch) {
      move({ movementY: touch.pageY - previousTouch.pageY });
    }

    previousTouch = touch;
  });

  slider.addEventListener("wheel", throttle((e) => {
    if (can_move) setCenter(e.deltaY > 0 ? -6 : 6);
  }))

  /*************************************/

  setCenter(null)


</script>
</body>
</html>


